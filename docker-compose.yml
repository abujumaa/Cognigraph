version: '3.8'

services:
  # Graph Database
  neo4j:
    image: neo4j:5.15.0
    container_name: cognigraph-neo4j
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
    volumes:
      - ./data/neo4j/data:/data
      - ./data/neo4j/logs:/logs
    networks:
      - cognigraph-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Vector Database
  qdrant:
    image: qdrant/qdrant:v1.7.3
    container_name: cognigraph-qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      - cognigraph-net

  # AI Serving (Ray Serve + VLLM)
  # Note: VLLM requires GPU support. For local dev without GPU, this might mock or fail.
  # This container acts as the Ray Head node.
  ray-serve:
    image: rayproject/ray:2.9.0-py310
    container_name: cognigraph-ray
    ports:
      - "8000:8000" # Serve
      - "8265:8265" # Dashboard
    command: /bin/bash -c "ray start --head --dashboard-host=0.0.0.0 --port=6379 --dashboard-port=8265 --block & serve start --http-host=0.0.0.0 --http-port=8000 && tail -f /dev/null"
    shm_size: 4gb # VLLM often needs shared memory
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - cognigraph-net
    environment:
      - RAY_ADDRESS=auto

  # Backend API Gateway
  api:
    build: .
    container_name: cognigraph-api
    ports:
      - "8080:8080"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
      - QDRANT_URL=http://qdrant:6333
      - RAY_SERVE_URL=http://ray-serve:8000
    depends_on:
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_started
      ray-serve:
        condition: service_started
    networks:
      - cognigraph-net
    volumes:
      - ./src:/app/src # Hot reload mount

networks:
  cognigraph-net:
    driver: bridge
